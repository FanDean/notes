# Lucene

此为读书笔记。





## 主流全文索引工具的比较

 Lucene, Sphinx, solr, Elasticsearch



Lucene是apache软件基金会4 jakarta项目组的一个子项目，是一个开放源代码的全文检索引擎工具包，但它不是一个完整的全文检索引擎，而是一个全文检索引擎的架构，提供了完整的查询引擎和索引引擎，部分文本分析引擎。

- Lucene是一套用于全文检索和搜寻的开源程式库，由Apache软件基金会支持和提供。
  Lucene提供了一个简单却强大的应用程式接口，能够做全文索引和搜寻，	在Java开发环境里Lucene是一个成熟的免费开放源代码工具。
- Lucene并不是现成的搜索引擎产品，但可以用来制作搜索引擎产品。



Lucene和搜索引擎不同，Lucene是一套用java或其它语言写的全文检索的工具包，为应用程序提供了很多个api接口去调用，可以简单理解为是一套实现全文检索的类库，搜索引擎是一个全文检索系统，它是一个单独运行的软件系统。



1. lucene  (solr, elasticsearch 都是基于lucene）  
2. sphinx  





## 数据分类

**结构化数据**：指具有固定格式或有限长度的数据，如数据库行数据：存在数据库中，可以用二维表结构来逻辑表达实现的数据

**非结构化数据**：指不定长度或者无固定格式的数据，如邮件、word文档、音频、超音频等

**半结构化数据**：对于这种数据可以按照结构化数据来处理，也可以提取纯文本按照非结构化数据来处理，如xml数据



对于非结构化的数据常用的检索方式有**顺序扫描**、**索引（Index）**

对于非结构化数据采用索引检索又可以说是全文检索（Full-Text-Search），在索引过程中，我大致给它分成两大步骤：

- 索引创建（Indexing）：将结构化数据或非结构化数据提取信息创建索引的过程。比如可以将文件系统数据、数据库数据、web数据等，通过索引的创建，形成最终的索引文件

- 搜索索引（Search）根据用户的查询条件，检索已创建的索引，返回查询结果的过程



> 老师上课时详细讲解了一下 索引的概念




## 索引

### 反向索引（倒排索引）

想象一下查字典的过程： 通过音节索引或者部首索引  查找  到想要查找的汉字所在的页码数 --> 翻到对应的页码，查看该汉字的解释。



> Lucene能够实现快速搜索响应，因为它不是直接搜索文本，而是搜索索引。这相当于通过搜索书籍背面的索引来检索与关键词相关的书中的页面，而不是搜索书籍每页中的单词。
>
> 这种类型的索引称为**反向索引**，因为它将以页面为中心的数据结构（page-> words）反转为以关键字为中心的数据结构（word-> pages）。



这种由字符串到文件的映射是文件到字符串映射的反向过程，我们就称这种信息为**反向索引**。 ？？



![](https://raw.githubusercontent.com/fandean/images/master/PicGo/%E5%80%92%E6%8E%92%E8%A1%A8.jpg)



上图中左半部分保存的信息，我们一般称为**字典**，左侧每一个字符串指向右侧的文档链接，此文档链表称为**倒排表**。 

**下面的示例有助于理解此图。**



### 如何创建索引



步骤：

1. 要检索的数据 （Document）
2. 分词技术（Analyzer）
3. 索引组建 （Indexer）



![](https://raw.githubusercontent.com/fandean/images/master/PicGo/20180912113236.png)





第一步数据：Document事例数据：

```
你好！我是小李。
中国在哪里？
你是谁？
lucene基础知识学习课程。
你在中石油上学？
中石油在哪里？
```



第二步：分词技术，这里采用StandarAnalyzer(标准分词)

```
你|好|我|是|小|李|
中|国|在|哪|里|
你|是|谁|
lucene|基|础|知|识|学|习|课|程|
你|在|中|石|油|上|学|
中|石|油|在|哪|里|
```

第三步之：索引创建字典：



![](https://raw.githubusercontent.com/fandean/images/master/PicGo/20180912114102.png)

> Term :  词， 词语



第三步之：索引组建合并词成倒排表：

![](https://raw.githubusercontent.com/fandean/images/master/PicGo/20180912114238.png)

分析上表，`term` 对应之前图示中的**字典**， `id` 对应 **倒排表**。

其中`id` 列 中的 `1>3>5` 表示第 1，3，5 行的源数据中包含此 分词。





### 如何检索

四步曲：**获取检索词（KeyWords**）、**分词技术（Analyzer）**、**检索索引（Aearch）**、**返回结果列表**

![](https://raw.githubusercontent.com/fandean/images/master/PicGo/20180912141635.png)



第一步：KeyWord事例数据

```
中石油
```



第二步：分词技术（因为创建索引的时候，采用的是标准分词，索引在搜索的过程，也应该采用该分词技术）

```
中|石|油|
```



第三步：检索索引搜索记录

![](https://raw.githubusercontent.com/fandean/images/master/PicGo/20180912141827.png)



第四步：返回结果列表

```
中石油在哪里？
你在中石油上学？
```





### 示例：在Java代码中创建索引



#### 几个术语(重要)



- **索引**：在Lucene中一个索引是放在一个文件夹中的，同一文件夹中的所有的文件构成一个Lucene索引。



- **文档（Document）**

  文档是创建索引的基本单位，不同的文档保存在不同的段中，一个段可以包含多个文档，新添的文档保存在一个新生成的一个段中，随着段的合并，不同的段会合并成一个新段。

  - **域（Field）** 

    一个文档包含不同类型的信息，比如小说信息可以有书名、作者名、更新时间、简介、更新时间等属性，这些都可以保存在不同的域中。**文档由一个或多个字段组成。**Field只是一个 `键-值`对。




- **词元（Term）**

  词是索引的最小单位，**是经过词法分析和语言处理后的字符串**。



在不同field中的相同字符串是不同的term，因此term表示一对字符串，第一个用以命名field，第二个用以命名field中的text；

文档是Lucene搜索和索引的原子单位，文档为包含一个或者多个域的容器，而域则是依次包含“真正的”被搜索的内容，域值通过分词技术处理，得到多个词元。



在Lucene中，**文档**是搜索（搜索索引）和（创建索引）索引的单位。

索引由一个或多个文档组成（在逻辑上）。

**索引(创建索引)涉及将文档添加到IndexWriter，搜索涉及通过IndexSearcher从索引中检索文档。**



搜索需要事先已经构建了索引。它涉及创建一个**Query**（通常通过QueryParser）并将此Query交给一个**IndexSearcher**，它返回一个Hits列表。







> 文档类似于关系数据库中的行。多个键及其关联的值有序的放置在一起便是文档。**在JS中，文档表示为对象**。
>
> 每个文档都有一个特殊的键`_id`，它在文档所处的集合中是唯一的。





> ### Lucene索引中的正向信息
>
> 正向信息按层次保存了从index一直到term的包含关系：`索引(Index) –> 段(segment) –> 文档(Document) –> 域(Field) –> 词(Term)`
> 也即此索引包含了那些段，每个段包含了那些文档，每个文档包含了那些域，每个域包含了那些词。既然是层次结构，则每个层次都保存了本层次的信息以及下一层次的元信息，也即属性信息。
> 包含正向信息的文件有：
>
> - segments_N保存了此索引包含多少个段，每个段包含多少篇文档。
> - XXX.fnm保存了此段包含了多少个域，每个域的名称及索引方式。
> - XXX.fdx，XXX.fdt保存了此段包含的所有文档，每篇文档包含了多少域，每个域保存了那些信息。
> - XXX.tvx，XXX.tvd，XXX.tvf保存了此段包含多少文档，每篇文档包含了多少域，每个域包含了多少词，每个词的字符串，位置等信息。
>
>
>
> ### Lucene索引中的反向信息
>
> 反向信息保存了词典到倒排表的映射：`词(Term) –> 文档(Document)`
> 包含反向信息的文件有：
>
> - XXX.tis，XXX.tii保存了词典(Term Dictionary)，也即此段包含的所有的词按字典顺序的排序。
> - XXX.frq保存了倒排表，也即包含每个词的文档ID列表。
> - XXX.prx保存了倒排表中每个词在包含此词的文档中的位置。
>
>
>
> Lucene **索引文件** 中，用一下基本类型来保存信息： 
>
> - Byte
> - UInt32
> - UInt64
> - VInt
> - Chars
> - String







## 分词器



何时分词？ 分词的作用？ 分词的存在形式？



在对Docuemnt中的内容进行索引之前，需要使用分词器进行分词 ，分词的目的是为了搜索。分词的主要过程就是先分词后过滤。

- 分词：采集到的数据会存储到document对象的Field域中，**分词就是将Document中Field的value值切分成一个一个的词**。（分词并不存储在 Field中）
- 过滤：包括去除标点符号过滤、去除停用词过滤（的、是、a、an、the等）、大写转小写、词的形还原（复数形式转成单数形参、过去式转成现在式。。。）等。 



###  索引时使用Analyzer

输入关键字进行搜索，当需要让该关键字与文档域内容所包含的词进行匹配时需要对文档域内容进行分析，需要经过Analyzer分析器处理生成语汇单元（Token）。分析器分析的对象是文档中的Field域。当Field的属性tokenized（是否分词）为true时会对Field值进行分析，如下图：

![53557913751](G:/Heima/08_Oracle/Lucene/%E8%AE%B2%E4%B9%89/%E5%A2%9E%E5%8A%A0%E7%9A%84%E7%89%88%E6%9C%AC/images/1535579137517.png)

对于一些Field可以不用分析：

- 不作为查询条件的内容，比如文件路径
- 不是匹配内容中的词而匹配Field的整体内容，比如订单号、身份证号等。



### 搜索时使用Analyzer

对搜索关键字进行分析和索引分析一样，使用Analyzer对搜索关键字进行分析、分词处理，使用分析后每个词语进行搜索。比如：搜索关键字：spring web ，经过分析器进行分词，得出：spring  web拿词去索引词典表查找 ，找到索引链接到Document，解析Document内容。

对于匹配整体Field域的查询可以0在搜索时不分析，比如根据订单号、身份证号查询等。

**注意：搜索使用的分析器要和索引使用的分析器一致**





## Field域



Field是文档中的域，包括Field名和Field值两部分，一个文档可以包括多个Field，Document只是Field的一个承载体，Field值即为要索引的内容，也是要搜索的内容。



- 是否分词(tokenized)

是：作分词处理，即将Field值进行分词，分词的目的是为了索引。

比如：商品名称、商品描述等，这些内容用户要输入关键字搜索，由于搜索的内容格式大、内容多需要分词后将语汇单元建立索引

 否：不作分词处理

比如：商品id、订单号、身份证号等 



- 是否索引(indexed)

是：进行索引。将Field分词后的词或整个Field值进行索引，存储到索引域，索引的目的是为了搜索。

比如：商品名称、商品描述分析后进行索引，订单号、身份证号不用分词但也要索引，这些将来都要作为查询条件。

否：不索引。
比如：图片路径、文件路径等，不用作为查询条件的不用索引。



- 是否存储(stored)

是：将Field值存储在文档域中，存储在文档域中的Field才可以从Document中获取。

比如：商品名称、订单号，凡是将来要从Document中获取的Field都要存储。

否：不存储Field值
比如：商品描述，内容较大不用存储。如果要向用户展示商品描述可以从系统的关系数据库中获取。









## 相关工具

### lucene索引查看工具Luke

[DmitryKey/luke: This is mavenised Luke: Lucene Toolbox Project](https://github.com/DmitryKey/luke "DmitryKey/luke: This is mavenised Luke: Lucene Toolbox Project")

用来查看 Lucene 产生的 索引文件



Luck 的版本和 lucene 的版本 还和 jdk 的版本都需要对应才能正常使用。





## 学习资料



- [Lucene案例开发 · 看云](https://www.kancloud.cn/digest/lulei-lucene "Lucene案例开发 · 看云") 强烈推荐
- [Lucene学习笔记 - Geosmart's Notes](http://geosmart.github.io/2016/04/29/Lucene%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ "Lucene学习笔记 | Geosmart's Notes") （后半部分，不错）
- [Basic Concepts - Lucene Tutorial.com](http://www.lucenetutorial.com/basic-concepts.html "Basic Concepts - Lucene Tutorial.com") 













