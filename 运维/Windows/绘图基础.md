# 绘图基础与位图


# 5 绘图基础

## GDI的结构

> 《Windows程序设计(第5版，珍藏版)》第5章 绘图基础

Windows子系统负责在称为图像设备接口（Graphics Dievice Interface，GDI）的视频显示器和打印机上显示图形。Windows程序应当毫无问题的在Windows所支持的任何图形设备上输出。GDI提供了一种特殊的机制来彻底隔离应用程序和不同输出设备的特性，这样就可以支持与设备无关的图形。



### GDI的基本图形

在屏幕或打印机上显示的图形类型可以分为下面几类：  

- 线条和曲线： 线条是任何矢量图形绘制系统的基础。GDI支持执行、矩形、椭圆、椭圆弧线和贝赛尔样条曲线。
- 可被填充的封闭区域： 当一系列的线条或者曲线构成一个封闭区域时，你可以使用当前GDI的画刷对象填充这个区域。
- 位图：位图是一个二维的位数组，每个元素对应显示设备上的一个像素。位图是光栅图形的基础。位图通常用于在视频显示器或者打印机上显示复杂的图像。
- 文本：文本在计算机图形学中的处理更加偏向艺术性；由于这个原因，文本通常是任何计算机图形系统中最复杂的部分，而且是最重要的部分（阅读文本是最主要的功能）（TrueType字体是以填充的轮廓线为基础；某些旧式的字体是基于位图的字体)

### GUI的其他方面

- 映射模式（Mapping Mode）和转换（Transform）：映射模式允许将默认的以像素单位映射为其他单位；转换用于倾斜和旋转图行对象（利用3x3矩阵表示的世界坐标转换world transform）
- 图元文件（matefile）：一个图元文件是以二进制形式存储的GDI命令的集合。图元文件主要用于通过剪贴板转换矢量图行绘制的表现形式。
- 区域（region）：区域是一个任意形状的封闭图形，通常可以表示为由一系列简单区域进行**布尔运算**后得到的结果。可以使用区域进行轮廓绘制、填充和剪裁。
- 路径（path）：路径是存储在GDI内部的直线和曲线的集合。可以用于绘制、填充和剪裁。路径还可以转换为区域。
- 剪裁（clipping）：当绘图被限制在客户区的一个特定的空间位置时，就发生了剪裁。那个特定的空间位置可以是矩形或者非矩形，它通常被指定为一个区域或者一个路径。
- 调色板（palettes）
- 打印（printing）


## 5.2 设备环境
如果希望在图形设备上绘制图形，必须首先获取设备环境（DC）的句柄。有了句柄就有了操作该设备的权限。

有几种方法获取与显示器上与一个特定的窗口相关联的设备环境：  

- BeginPaint函数： 使某个矩形区域有效，只可在该矩形区域内绘图。
- GetDC函数：可以在整个客户区内绘制
- GetWindowDC函数：获取整个窗口，包含标题栏、菜单、滚动条和客户区的外框。



### 设备的尺寸

假如你想绘制一个边长是1英寸的正方形。为了完成这个正方形，你或操作系统需要知道在视频显示器上的1英寸对应的像素数目。

**分辨率**：打印机通常使用每英寸的点数表示。但，视频显示器的分辨率却是以水平和垂直方向上像素的总数给出的。

在本书中，**分辨率**被严格地定义为每度量单位（通常是英寸）中含有的像素数。我们将使用“像素尺寸（pixel size）”或者“像素规模（pixel dimension）来表示设备在水平和垂直方向上显示的总的像素数。 ”度量尺寸（metrical size）和”度量规模(metrical dimension)" 是指以英寸或者毫米为单位的设备的客户区域的大小。  
像素尺寸除以度量尺寸等于分辨率。

> 关于字体部分略


### 色彩ABC

只能显示黑色像素和白色像素的视频显示器要显示每个像素只需要一位的内存。  
彩色显示器的每个像素却需要多个位的内存。2的位数次方就是它可以表示的不同色彩的数目。  


- 真彩（full color）：显示器有每像素24位的分辨率（8位表示红色、8位表示绿色、8位表示蓝色）红绿蓝为三原色。
- 高彩（high color)：显示器有每像素16为的分辨率。
- 一个显示256色的视频适配器每像素需要8位的内存。然而，这8位的值通常是一个索引值，它指向一个调色板中定义的某种实际颜色。(即256色的视频适配器会使用颜色调色板)
- 16色的视频板每像素需要4位的内存。


## 5.3 点和线的绘制

事实上，仅使用SetPixel和GetPixel函数，可以绘制几乎所有需要的图形，但是存在严重的性能问题。  

### 设定像素
SetPixel函数将坐标为x,y的像素点设置为某个特定的颜色。  
```c
//hdc为设备环境句柄；x,y为坐标值，crColor为要设置的颜色值
SetPixel(hdc,x,y,crColor);
```

> 使用SetPixel画一条线，GDI可以不停的调整x，y的坐标，同时连续调用SetPixel函数来设置这些像素点的颜色值来实现。

GetPixel函数返回指定坐标位置的像素的颜色。


> 此处还未涉及到画笔等概念



### 线条
系统提供的几种画线函数: 

- LineTo，画直线
- Polyline和PolylineTo
- Arc，画椭圆弧线
- ...


设备环境有5个属性会影响这些函数所绘制的线条的外观：  

- 当前画笔位置、
- 画笔、
- 背景模式
- 背景颜色
- 绘制模式



### 画笔

画笔决定线条的颜色、宽度和样式。（样式可以是实线、点线或虚线）。

Windows中使用句柄类操作画笔。画笔句柄的类型为 `HPEN`。

创建画笔的一般过程：  

1. 调用CreatePen或CreatePenIdirect函数创建一个"逻辑画笔"（返回一个逻辑画笔的句柄）
2. 调用SelecteObject将画笔选入设备环境中。
3. 使用这个画笔绘制线条。（一次只能有一支画笔被选入设备环境）
4. 在释放设备环境后，调用DeleteObject来删除该逻辑画笔。

> 逻辑画笔是一个"GDI"对象，一个程序可以创建6种GDI对象：  
> - 逻辑画笔
> - 画刷
> - **位图**
> - 区域
> - 字体
> - 调色板


**填充空隙:**  

使用点式画笔和虚线画笔带来这样一个问题：点和虚线之间的空隙是什么颜色？  

空隙的颜色是由设备环境的两个属性（背景模式和背景颜色）决定的。可以调用相关函数进行更改。



### 绘图模式

一条直线，其颜色由画笔的颜色和画线显示区域的颜色共同决定。

当Windows使用一个画笔绘制直线时，它实际上是将画笔的像素颜色和目标显示表面的像素的颜色按位进行布尔运行。  

对像素颜色执行一个按位布尔运算称为**“光栅操作(raster operation, ROP)”，简称ROP**。

因为绘制一条直线只涉及两种像颜色（即目标和画笔），这里的布尔运算就被称作"二元光栅操作"


如下章节略： 

```
## 5.4 绘制填充区域

### 用画刷填充内部


## 5.5 GDI映射模式

### 设备坐标和逻辑坐标

### 度量映射模式


## 5.6 矩形、区域和剪裁
```



# 14 位图

> 《Windows程序设计(第5版，珍藏版)》第14章

> 另可参考《MFC Windows程序设计（第2版，修订版）》第15章： 位图、调色板以及区域


位图（bitmap）是一个二维矩形数组，对应于一个图像的像素。

当现实生活中的图像被存放为位图时，图像被分成网格，像素则是基本采样单元。位图中每个像素的值代表网格的一个单元中的图像的平均颜色。

Windows程序中存储图像信息有两种方法，位图是其中的一种。另一种是图元文件（metafile）。

本章讲述GDI位图对象（也叫设备相关位图（Device-dependent Bitmap），简称DDB）；Windows 3.0引入了设备无关位图（Device-Independent Bitmap, DIB）它提供了一个用来交换图像的文件格式。


## 位图基础

**位图**: 经常被用来表示来自现实世界的复杂的图像。   

**图元文件**：则更适合人工产生的或计算机产生的图像，比如建筑结构图。

位图和图元文件的区别在于点阵图形和矢量图形的区别。

点阵图形，把输出设备当成离散的像素处理。  
矢量图形，把输出设备当成笛卡尔坐标系，在上面可以画线和填充物体。

位图的两个主要缺点：  

1. 受设备相关问题的影响。最明显的就是色彩；另还存在图像缩放时的图形失真。
2. 位图需要很大的存储空间。（而图元文件的存储空间由图像的复杂度和它所包含的GDI命令的个数来决定）。

位图的优点之一是绘制显示一个位图比绘制一个图元文件要快的多。








## 设备无关位图DIB
Windows 3.0引入了设备无关位图（Device-Independent Bitmap, DIB）它提供了一个用来交换图像的文件格式。

最好先把DIB想象为一种文件格式。DIB文件的扩展名是BMP。

